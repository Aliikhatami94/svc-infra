services:
  api:
    image: python:3.12-slim
    container_name: svc-infra-accept-api
    working_dir: /workspace
    environment:
      - BACKEND=${BACKEND:-}
      - APP_ENV=dev
      - PYTHONUNBUFFERED=1
      - PIP_DEFAULT_TIMEOUT=120
      - PYTHONPATH=/workspace/src:/workspace
      - LOG_LEVEL=INFO
      - ENABLE_LOGGING=true
      - ENABLE_OBS=true
      - METRICS_PATH=/metrics
      - OBS_SKIP_PATHS=/metrics,/health
      - APF_PAYMENTS_PROVIDER=fake
      # Redis URL is available if used by the app
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./:/workspace:cached
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; sys.exit(0) if urllib.request.urlopen('http://localhost:8000/ping', timeout=2).status==200 else sys.exit(1)"]
      interval: 3s
      timeout: 3s
      retries: 120
      start_period: 180s
    command:
      - bash
      - -lc
      - |
        set -euxo pipefail
        python -m pip install --root-user-action=ignore --no-cache-dir -U pip
        # Install the project to bring all required runtime deps (fastapi, sqlalchemy, etc.)
        python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary /workspace
        # Ensure optional runtime deps used by acceptance are present
        python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary aiosqlite prometheus-client pyjwt
        # Explicitly install uvicorn (not a project dep) and httptools for HTTP/1.1 streaming support
        python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary uvicorn httptools
        # Optional drivers for Postgres profiles
        if [ "${BACKEND:-}" = "pg" ] || [ "${BACKEND:-}" = "pg-redis" ]; then python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary asyncpg; fi
        uvicorn tests.acceptance.app:app --host 0.0.0.0 --port 8000

  redis:
    image: redis:7-alpine
    container_name: svc-infra-accept-redis
    profiles: ["pg-redis"]
    command: ["redis-server", "--appendonly", "no"]

  db:
    image: postgres:16-alpine
    container_name: svc-infra-accept-db
    profiles: ["pg-redis"]
    environment:
      - POSTGRES_DB=app
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 10

  tester:
    image: python:3.12-slim
    container_name: svc-infra-accept-tester
    working_dir: /workspace
    environment:
      - BACKEND=${BACKEND:-}
      - APP_ENV=test
      - PYTHONUNBUFFERED=1
      - PIP_DEFAULT_TIMEOUT=120
      - PYTHONPATH=/workspace/src:/workspace
      - BASE_URL=http://api:8000
    volumes:
      - ./:/workspace:cached
    depends_on:
      - api
    command:
      - bash
      - -lc
      - |
        set -euxo pipefail
        python -m pip install --root-user-action=ignore --no-cache-dir -U pip
        # Install the project to ensure FastAPI/Starlette and all runtime deps are present
        python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary /workspace
        # Test-only deps + optional driver used by acceptance (sqlite+aiosqlite URL)
        python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary pytest pytest-asyncio httpx pyjwt aiosqlite
        if [ "${BACKEND:-}" = "pg" ] || [ "${BACKEND:-}" = "pg-redis" ]; then python -m pip install --root-user-action=ignore --no-cache-dir --prefer-binary asyncpg; fi
        cat >/tmp/wait_api.py <<'PY'
        import sys, time, urllib.request
        url = 'http://api:8000/ping'
        ok = False
        for i in range(90):
            try:
                with urllib.request.urlopen(url, timeout=2) as r:
                    ok = (r.status == 200)
                    print('API ready' if ok else f'status {r.status}')
                    break
            except Exception as e:
                print(f'waiting for API: {e}')
                time.sleep(1)
        sys.exit(0 if ok else 1)
        PY
        python /tmp/wait_api.py
        pytest -q -m acceptance tests/acceptance

networks:
  default:
    name: svc-infra-accept
