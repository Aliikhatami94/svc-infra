from __future__ import annotations
from typing import Optional
from fastapi import APIRouter, Request, HTTPException, Depends
from fastapi.responses import RedirectResponse
from authlib.integrations.starlette_client import OAuth
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from fastapi_users.password import PasswordHelper

from .settings import get_auth_settings
from .models import User
from .users import get_jwt_strategy
from $session_dep_import import SessionDep  # e.g. "from app.db.integration.fastapi import SessionDep"

def oauth_router() -> APIRouter:
    settings = get_auth_settings()
    oauth = OAuth()
    password_helper = PasswordHelper()

    if settings.google_client_id and settings.google_client_secret:
        oauth.register(
            "google",
            client_id=settings.google_client_id,
            client_secret=settings.google_client_secret.get_secret_value(),
            server_metadata_url="https://accounts.google.com/.well-known/openid-configuration",
            client_kwargs={"scope": "openid email profile"},
        )

    if settings.github_client_id and settings.github_client_secret:
        oauth.register(
            "github",
            client_id=settings.github_client_id,
            client_secret=settings.github_client_secret.get_secret_value(),
            authorize_url="https://github.com/login/oauth/authorize",
            access_token_url="https://github.com/login/oauth/access_token",
            api_base_url="https://api.github.com/",
            client_kwargs={"scope": "user:email"},
        )

    r = APIRouter(prefix="$oauth_prefix", tags=["auth:oauth"])

    @r.get("/{provider}/login")
    async def oauth_login(request: Request, provider: str):
        client = oauth.create_client(provider)
        if not client:
            raise HTTPException(404, "Provider not configured")
        redirect_uri = request.url_for("oauth_callback", provider=provider)
        return await client.authorize_redirect(request, str(redirect_uri))

    @r.get("/{provider}/callback", name="oauth_callback")
    async def oauth_callback(request: Request, provider: str, session: SessionDep):
        client = oauth.create_client(provider)
        if not client:
            raise HTTPException(404, "Provider not configured")

        token = await client.authorize_access_token(request)

        if provider == "google":
            userinfo = token.get("userinfo") or await client.parse_id_token(request, token)
            email = userinfo.get("email")
            full_name = userinfo.get("name")
        elif provider == "github":
            resp = await client.get("user", token=token)
            data = resp.json()
            email = data.get("email")
            if not email:
                emails = (await client.get("user/emails", token=token)).json()
                primary = next((e for e in emails if e.get("primary")), emails[0] if emails else {})
                email = primary.get("email")
            full_name = data.get("name")
        else:
            raise HTTPException(400, "Unsupported provider")

        if not email:
            raise HTTPException(400, "No email from provider")

        existing = (await session.execute(select(User).filter_by(email=email))).scalars().first()
        if existing:
            user = existing
        else:
            user = User(email=email, is_active=True, is_superuser=False, is_verified=True)
            user.hashed_password = PasswordHelper().hash("!oauth!")  # sentinel
            user.full_name = full_name
            session.add(user)
            await session.flush()

        jwt = get_jwt_strategy().write_token(user)
        return RedirectResponse(url=f"$post_login_redirect?token={jwt}")

    return r